function restartSignalR(){if(wsconn.connectionState=="Connected"||wsconn.M=="Connected"){clearInterval(checkConnectivity);return}wsconn.connectionState=="Disconnected"&&(wsconn.stop(),initializeSignalR())}function timerDisplayFun(){var r=new Date,n=r-dt1,t=Math.floor(n/1e3%60),i=Math.floor(n/6e4);document.querySelector(".recording-timer-display label").innerHTML=(i<10?"0":"")+i.toString()+":"+(t<10?"0":"")+t.toString();videoaudiotimer=setTimeout(timerDisplayFun,1e3)}function thisSignalReceiveBefore(n,t,i){for(var r=0;r<beforeSignals.length;r++)if(JSON.stringify(beforeSignals[r].connection)==JSON.stringify(n)&&beforeSignals[r].partnerClientId==t&&JSON.stringify(beforeSignals[r].candidate)==JSON.stringify(i))return!0;return!1}function createAnswerWhenVideoOrAudioIsReady(n,t){localStream==null?setTimeout(function(){createAnswerWhenVideoOrAudioIsReady(n,t)},500):(console.log("WebRTC: remote Description type offer"),console.log("localStream:",localStream),n.addStream(localStream),console.log("WebRTC: added stream"),n.createAnswer().then(i=>{console.log("WebRTC: create Answer..."),n.setLocalDescription(i,()=>{console.log("WebRTC: set Local Description..."),console.log("connection.localDescription: ",n.localDescription),sendHubSignal(JSON.stringify({sdp:n.localDescription}),t)},errorHandler)},errorHandler))}function createOfferWhenLocalStreamIsReady(n,t){try{t==null?setTimeout(function(){createOfferWhenLocalStreamIsReady(n,t)},500):(initiateOffer(n.connectionId,t),$("body").attr("data-mode","incall"),$("#ChatPmModal").modal("hide"),$("#callstatus").text("In Call"),console.log("signalr_callAccepted","end"))}catch(i){}}function ProcessReceiveMessege(n,t,i){var f,e,a,h,y,v,l,s,u,c,r;if(notifring.play(),f=n.split(";;;")[1],n.startsWith("delmess;,;")){t?$(".contact[data-id="+t.toLowerCase()+"]").hasClass("active")&&(e=n.replace("delmess;,;","").split(";;;")[0],a=e.split(","),$.each(a,function(n){var t=a[n];$("ul li[data-id="+t+"]").remove()})):$(".contact[data-id="+f+"]").hasClass("active")&&(e=n.replace("delmess;,;","").split(";;;")[0],$("ul li[data-id="+e+"]").remove());return}if(n.startsWith("customNotif:")){try{var v=n.split(";;;")[3],w=n.split(";;;")[2],b=n.split(";;;")[4];JSBridge.setCustomNotification(w,b,parseInt(v))}catch{}return}if(t)h=$(".contact[data-id="+t.toLowerCase()+"] .text-bg-success").html(),h==undefined&&appendNewContactById(t,!0);else if(h=$(".contact[data-id="+f.toLowerCase()+"] .text-bg-success").html(),h==undefined){appendNewContactById(f);return}h?(y=parseInt(h.replace(" ","").replace("(","").replace(")","")),y++,$(".contact[data-id="+(t?t:f).toLowerCase()+"] .text-bg-success").html(y)):$(".contact[data-id="+(t?t:f).toLowerCase()+"] .text-bg-success").html("1");try{v=n.split(";;;")[3];JSBridge.setNotification("you have new message",v)}catch{}if($(".contact[data-id="+(t?t:f).toLowerCase()+"]").hasClass("active")){var k=new Date,p=n.split(";;;")[0],o=n.split(";;;")[2];if(e=n.split(";;;")[3],l=n.split(";;;")[4],s="",p=="isfile")for(u=o.split(",;,")[0].split(";"),c="",o.split(",;,").length>1&&(c=o.split(",;,")[1]),r=0;r<u.length;r++)s+=`<li class="from-other" data-id="`+e+`" >`,s+=t?"<div class='name'>"+i+"<\/div>":"",c&&(s+=`<div class="newcard" data-id="`+(l?l:"")+`" >
                      <div class="card-header" `+ForwardSenderId(c)+`>`+c.split(",@,")[0]+`</div>`),s+=IsImage(u[r])?`<label><a data-url="/Home/GetFile?fileName=`+u[r]+`&fileType=up" class="img-tag"><div><img  class="fupload" src="/Home/GetFile?fileName=`+u[r]+`&fileType=up&th=true" /></div><div>`+u[r]+`</div></a></label>`:IsAudio(u[r])?`<label><div><audio controls src="/Home/GetFile?fileName=`+u[r]+`&fileType=up" ></audio></div><div> `+u[r]+`</div></label>`:IsVideo(u[r])?`<label><div><video controls  ><source src="/Home/GetFile?fileName=`+u[r]+`&fileType=up" ></video></div><div> `+u[r]+`</div></label>`:IsPdfOrDoc(u[r])?`<label><a href="/Home/GetFile?fileName=`+u[r]+`&fileType=up" target="_blank" ><div><img class="docpdfimg" src="/Home/GetFile?fileName=`+u[r].substring(0,u[r].lastIndexOf("."))+`.jpg&fileType=up&th=true" /></div><div>`+u[r]+`</div></a></label>`:`<label><a href="/Home/GetFile?fileName=`+u[r]+`&fileType=up" target="_blank" ><div><img src="/img/file-icon.png" /></div><div>`+u[r]+`</div></a></label>`,c&&(s+=`</div>`),s+=`</li><li  class="from-other"><div class="date">`+getNiceDateTimeFormat(k)+`</div></li>`;else s+=`<li class="from-other"  data-id="`+e+`" >`+(t?"<div class='name'>"+i+"<\/div>":"")+(o.indexOf(",;,")>=0?`<div class="newcard" data-id="`+(l?l:"")+`" >
                      <div class="card-header">`+o.split(",;,")[0]+`</div><label `+checkRtlOfText(o.split(",;,")[1])+`>`+textToWrite(o.split(",;,")[1])+`</label></div>`:`<label`+checkRtlOfText(o)+`>`+textToWrite(o)+`</label>`)+`</li><li  class="from-other"><div class="date">`+getNiceDateTimeFormat(p)+`</div></li>`;t?wsconn.invoke("SeenMessegeForGroup",e,f,t):wsconn.invoke("SeenMessege",e,f);$("#lastchat").before(s);$("li .newcard:not(.card) .card-header").on("click",function(){var n=$(this).parent().data("id");$(".chat-pm ul").scrollTop($('[data-id="'+n+'"]').get(0).offsetTop-90);$('[data-id="'+n+'"]').eq(0).css("background","black");setTimeout(function(){$('[data-id="'+n+'"]').eq(0).css("background","transparent")},500);setTimeout(function(){$('[data-id="'+n+'"]').eq(0).css("background","black")},1e3);setTimeout(function(){$('[data-id="'+n+'"]').eq(0).css("background","transparent")},1500)});$("li .newcard:not(.card)").addClass("card");setTimeout(function(){$(".chat-pm ul").scrollTop($(".chat-pm ul").get(0).scrollHeight)},500);loadForSelectLi();$(".img-tag").unbind("click");$(".img-tag").on("click",function(){var n=$(this).data("url");loadImageModal(n)})}}function appendNewContactById(n){$.post("/Home/GetAccounts",{searchKey:n},function(n){var t;if(n.length!=0)for($(".no-mess-contact").hide(),t=0;t<n.length;t++){var i=n[t].contactName?n[t].contactName:n[t].userName,r=n[t].profilePic?"/ProfilePics/thumbnails/"+n[t].profilePic:n[t].isGroup?"/img/group-icon.png":"/img/person-icon.png",u=`<div class="mess row contact new-def-mess def-mess" minid="`+n[t].minid+`" data-id="`+n[t].userId+`">
                                <div class="col-12 d-inline px-3">
                                    <div class="float-start">
                                        <img src="`+r+`" class="img-pro online">
                                    </div>
                                    <div class="float-start text-start px-2">
                                        <div class="pro">
                                                <label class="name">`+i+`</label>
                                                <label class="company">`+n[t].companyTitle+`</label>
                                                <label class="role">`+n[t].position+`</label>
                                        </div>
                                    </div>
                                    <div class="float-end chat-num">
                                        <label class="badge text-bg-success">1</label>
                                    </div>
                                </div>
                            </div>`;$(".contacts").children().first().before(u);$(".new-def-mess").on("click",function(){var n,t;$(".contact").removeClass("new-def-mess");$(".contact").removeClass("active");$(this).addClass("active");n=$(this).data("id");$(".loading").show();t=$(this).data("id");$.post("/Home/GetContactMessage",{minId:"0",contactId:n},function(n){$(".loading").hide();n==null||n.length==0?SetEmptyMessage():SetResultOfMessage(n)})});$(".new-def-mess").addClass("def-mess").removeClass("new-def-mess")}})}function sendBySignalRToGroup(n,t){this.wsconn.invoke("SendMessageToGroup",n,t).catch(n=>console.log(n))}function sendBySignalR(n,t){this.wsconn.invoke("SendMessage",n,t).catch(n=>console.log(n))}function sendBySignalRForDel(n,t){this.wsconn.invoke("SendMessage",n,"delmess;,;"+t).catch(function(n){return console.log(n.toString())})}function SendNotConnectAlert(n){alertify.confirm(n,function(n){n&&window.location.reload();sendNotConnectMess=!1}).set({title:"Rasa IT"}).set("closable",!1).set("labels",{ok:"Refresh",cancel:"Wait for now"})}var sendNotConnectMess=!1,peerConnectionConfig,videoaudiotimer,dt1,beforeSignals;const isDebugging=!0;var hubUrl="/ConnectionHub",isVideoCall=!1,wsconn=(new signalR.HubConnectionBuilder).withUrl(hubUrl,signalR.HttpTransportType.WebSockets).withAutomaticReconnect({nextRetryDelayInMilliseconds:()=>{$(".chat h5.chatpage").html("Rasa IT     Connecting...");checkConnectivity=setInterval(function(){restartSignalR()},2e3);try{wsconn.stop()}catch(n){}return restartSignalR(),1e6}}).configureLogging(signalR.LogLevel.None).build(),checkConnectivity;peerConnectionConfig={iceServers:[{url:"stun:stun.l.google.com:19302"}]};$(document).ready(function(){initializeSignalR();$(document).on("click",".user",function(){$("#call-status-lbl").html("calling user...");console.log("calling user... ");var n=$(this).attr("UserId");if($("body").attr("data-mode")!=="idle"){alertify.error("Sorry, you are already in a call.  Conferencing is not yet implemented.",5);return}n!=myUserId?(wsconn.invoke("callUser",n),dt1=new Date,setTimeout(timerDisplayFun,1e3),$("body").attr("data-mode","calling"),$("#callstatus").text("Calling...")):(alertify.error("Ah, nope.  Can't call yourself.",5),clearInterval(videoaudiotimer))})});$(".hangup").click(function(){try{wsconn.stop()}catch(n){}try{restartSignalR()}catch(n){}beepring.pause();beepring.currentTime=0;beepring.volume=0;console.log("hangup....");clearInterval(videoaudiotimer);$("body").attr("data-mode")!=="idle"&&(wsconn.invoke("HangUp"),closeAllConnections(),$("#VideoCallModal").modal("hide"),$("body").attr("data-mode","idle"),$("#callstatus").text("Idle"),localStream=null,remoteStream=null)});var webrtcConstraints={audio:!0,video:{width:{exact:320},height:{exact:240},frameRate:{exact:3}}},webrtcVoiceConstraints={audio:!0,video:!1},streamInfo={applicationName:WOWZA_APPLICATION_NAME,streamName:WOWZA_STREAM_NAME,sessionId:WOWZA_SESSION_ID_EMPTY};const localVideo=document.getElementById("localVideo"),remoteVideo=document.getElementById("remoteVideo"),partnerAudio=document.querySelector(".audio.partner");var WOWZA_STREAM_NAME=null,connections={},localStream=null;remoteStream=null;attachMediaStream=n=>{console.log("OnPage: called attachMediaStream"),remoteStream=n.stream,dt1=new Date,videoaudiotimer=setTimeout(timerDisplayFun,1e3),isVideoCall?remoteVideo.srcObject=n.stream:partnerAudio.srcObject=n.stream};beforeSignals=[];const receivedCandidateSignal=(n,t,i)=>{thisSignalReceiveBefore(n,t,i)||(beforeSignals.push({connection:n,partnerClientId:t,candidate:i}),console.log("WebRTC: adding full candidate"),n.addIceCandidate(new RTCIceCandidate(i),()=>console.log("WebRTC: added candidate successfully"),()=>console.log("WebRTC: cannot add candidate")))};const receivedSdpSignal=(n,t,i)=>{console.log("connection: ",n),console.log("sdp",i),console.log("WebRTC: called receivedSdpSignal"),console.log("WebRTC: processing sdp signal"),n.setRemoteDescription(new RTCSessionDescription(i),()=>{console.log("WebRTC: set Remote Description"),n.remoteDescription.type=="offer"?createAnswerWhenVideoOrAudioIsReady(n,t):n.remoteDescription.type=="answer"&&console.log("WebRTC: remote Description type answer")},errorHandler)};const newSignal=(n,t)=>{console.log("WebRTC: called newSignal");var i=JSON.parse(t),r=getConnection(n);console.log("connection: ",r);i.sdp?(console.log("WebRTC: sdp signal"),receivedSdpSignal(r,n,i.sdp)):i.candidate?(console.log("WebRTC: candidate signal"),receivedCandidateSignal(r,n,i.candidate)):(console.log("WebRTC: adding null candidate"),r.addIceCandidate(null,()=>console.log("WebRTC: added null candidate successfully"),()=>console.log("WebRTC: cannot add null candidate")))},onReadyForStream=n=>{console.log("WebRTC: called onReadyForStream"),n.addStream(localStream),console.log("WebRTC: added stream")},onStreamRemoved=()=>{console.log("WebRTC: onStreamRemoved -> Removing stream: ")},closeConnection=n=>{restartSignalR();console.log("WebRTC: called closeConnection ");var t=connections[n];t&&(onStreamRemoved(null,null),localStream&&localStream.getTracks().forEach(function(n){n.stop()}),remoteStream&&remoteStream.getTracks().forEach(function(n){n.stop()}),$("#VideoCallModal").modal("hide"),t.close(),delete connections[n])},closeAllConnections=()=>{try{wsconn.stop()}catch(t){}try{restartSignalR()}catch(t){}console.log("WebRTC: call closeAllConnections ");for(var n in connections)closeConnection(n);localStream&&localStream.getTracks().forEach(function(n){n.stop()});remoteStream&&remoteStream.getTracks().forEach(function(n){n.stop()});localStream=null;remoteStream=null},getConnection=n=>(console.log("WebRTC: called getConnection"),connections[n]?(console.log("WebRTC: connections partner client exist"),connections[n]):(console.log("WebRTC: initialize new connection"),initializeConnection(n))),initiateOffer=(n,t)=>{console.log("WebRTC: called initiateoffer: ");var i=getConnection(n);i.addStream(t);console.log("WebRTC: Added local stream");i.createOffer().then(t=>{console.log("WebRTC: created Offer: "),console.log("WebRTC: Description after offer: ",t),i.setLocalDescription(t).then(()=>{console.log("WebRTC: set Local Description: "),console.log("connection before sending offer ",i),sendHubSignal(JSON.stringify({sdp:i.localDescription}),n)}).catch(n=>console.error("WebRTC: Error while setting local description",n))}).catch(n=>console.error("WebRTC: Error while creating offer",n))},callbackUserMediaSuccess=n=>{console.log("WebRTC: got media stream"),localStream=n,isVideoCall&&(localVideo.srcObject=n)},initializeUserMediaVideo=()=>{console.log("WebRTC: InitializeUserMedia: "),navigator.getUserMedia(webrtcConstraints,callbackUserMediaSuccess,errorHandler)},initializeUserMediaVoice=()=>{console.log("WebRTC: InitializeUserMedia: "),navigator.getUserMedia(webrtcVoiceConstraints,callbackUserMediaSuccess,errorHandler)},callbackRemoveStream=()=>{console.log("WebRTC: removing remote stream from partner window"),remoteVideo.srcObject=""},callbackAddStream=(n,t)=>{console.log("WebRTC: called callbackAddStream"),attachMediaStream(t)},callbackNegotiationNeeded=()=>{console.log("WebRTC: Negotiation needed...")},callbackIceCandidate=(n,t,i)=>{console.log("WebRTC: Ice Candidate callback"),n.candidate?(console.log("WebRTC: new ICE candidate"),sendHubSignal(JSON.stringify({candidate:n.candidate}),i)):(console.log("WebRTC: ICE candidate gathering complete"),sendHubSignal(JSON.stringify({candidate:null}),i))},initializeConnection=n=>{console.log("WebRTC: Initializing connection...");var t=new RTCPeerConnection(peerConnectionConfig);return t.oniceconnectionstatechange=function(){t.iceConnectionState=="disconnected"&&(console.log("Disconnected"),alertify.error("Sorry, you are already in a call.  Conferencing is not yet implemented.",5),setTimeout(function(){$(".hangup").trigger("click")},3e3))},t.onicecandidate=i=>callbackIceCandidate(i,t,n),t.onaddstream=n=>callbackAddStream(t,n),t.onremovestream=n=>callbackRemoveStream(t,n),connections[n]=t,t};sendHubSignal=(n,t)=>{console.log("candidate",n),console.log("SignalR: called sendhubsignal "),wsconn.invoke("sendSignal",n,t).catch(errorHandler),setTimeout(function(){wsconn.invoke("sendSignal",n,t).catch(errorHandler)},3e3),setTimeout(function(){wsconn.invoke("sendSignal",n,t).catch(errorHandler)},6e3)};wsconn.onclose(n=>{$(".chat h5.chatpage").html("Rasa IT     Connecting..."),n?(console.log("SignalR: closed with error."),console.log(n)):console.log("Disconnected"),checkConnectivity=setInterval(function(){restartSignalR()},2e3),restartSignalR()});wsconn.on("updateUserList",n=>{$(".chat h5.chatpage").html("Rasa IT"),n=JSON.parse(n),ul=n,$("#usersLength").text(n.length),$("#usersdata li.user").remove(),$(".contact img").removeClass("online"),$.each(n,function(t){var i="",r="";n[t].username===$("#upperUsername").text()&&(myConnectionId=n[t].connectionId,i="icon-employee",r="Me");i||(i=n[t].inCall?"icon-smartphone-1":"icon-smartphone-1");r=n[t].inCall?"In Call":"Available";$('.contact[data-id="'+n[t].userId.toLowerCase()+'"] img').addClass("online")})});wsconn.on("callAccepted",n=>{console.log("SignalR: call accepted from: "+n+".  Initiating WebRTC call and offering my stream up..."),n=JSON.parse(n),$("#call-status-lbl").html("Call accepted..."),beepring.pause(),beepring.currentTime=0,beepring.volume=0,dt1=new Date,videoaudiotimer=setTimeout(timerDisplayFun,1e3),setTimeout(function(){$("#call-status-lbl").html("Connected")},3e3),createOfferWhenLocalStreamIsReady(n,localStream)});wsconn.on("callDeclined",(n,t)=>{n=JSON.parse(n),console.log("SignalR: call declined from: "+n.connectionId),$("#call-status-lbl").html("Call Declined!"),beepring.pause(),beepring.currentTime=0,beepring.volume=0,alertify.error(t,5),setTimeout(function(){$(".hangup").trigger("click")},3e3)});wsconn.on("incomingCall",(n,t)=>{if($("#call-status-lbl").html("Call started"),console.log("SignalR: incoming"+(isVideoCall?" video ":" voice ")+"call from: "+n),n=JSON.parse(n),isVideoCall=t,$(".partner")[0].style.display="none",isVideoCall==!1?(localVideo.style.display="none",remoteVideo.style.display="none",$(".partner")[0].style.display="",$("#VideoCallModalLabel").html("Voice Call")):(localVideo.style.display="",remoteVideo.style.display="",$("#VideoCallModalLabel").html("Video Call")),isVideoCall)IsCameraPermission==!1&&(IsCameraPermission=JSBridge.getVideoPermission());else try{IsMicrophonePermission==!1&&JSBridge.getAudioPermission()}catch{}alertify.confirm(n.username+" is calling.  Do you want to"+(isVideoCall?" video ":" voice ")+"chat?",function(t){t?(isVideoCall==!1?initializeUserMediaVoice():initializeUserMediaVideo(),dt1=new Date,$.post("/Home/CallLogUpdate",{Status:2,ToUser:n.userId},function(){}),$("#VideoCallModal").modal("show"),wsconn.invoke("AnswerCall",!0,JSON.stringify(n)).catch(n=>console.log(n)),$("body").attr("data-mode","incall"),$("#callstatus").text("In Call")):wsconn.invoke("AnswerCall",!1,JSON.stringify(n)).catch(n=>console.log(n))}).set({title:"Rasa IT"}).set("closable",!1).set("labels",{ok:"Accept Call",cancel:"Reject Call"})});wsconn.on("receiveSignal",(n,t)=>{n=JSON.parse(n),newSignal(n.connectionId,t)});wsconn.on("callEnded",(n,t)=>{$("#call-status-lbl").html("Call ended");dt2=new Date;var i=dt2-dt1;n=JSON.parse(n);$.post("/Home/CallLogUpdate",{Status:2,ToUser:n.userId,duration:i/1e3},function(){});setTimeout(function(){$(".hangup").trigger("click")},3e3);console.log("SignalR: call with "+n.connectionId+" has ended: "+t);alertify.error(t,5);beepring.pause();beepring.currentTime=0;beepring.volume=0;closeConnection(n.connectionId);$("#callstatus").text("Idle")});wsconn.on("OnSeenMess",n=>{n=="all"?$("li span:not(.seen)").addClass("seen"):$("li[data-id="+n+"] span").addClass("seen")});wsconn.on("OnSeenMessForGroup",(n,t)=>{t=="all"?$("li span:not(.seen)").addClass("seen"):$("li[data-id="+t+"] span").addClass("seen")});wsconn.on("ReceiveMessageFromGroup",(n,t,i)=>{var r=t.split(";;;")[1];r!=myUserId&&ProcessReceiveMessege(t,n,i)});wsconn.on("ReceiveMessage",n=>{ProcessReceiveMessege(n)});const initializeSignalR=()=>{wsconn.start().then(()=>{$(".chat h5.chatpage").html("Rasa IT"),console.log("SignalR: Connected"),setUsername(myusername,myUserId),setTimeout(function(){setUsername(myusername,myUserId)},3e3),setTimeout(function(){setUsername(myusername,myUserId)},6e3)}).catch(n=>{$(".chat h5.chatpage").html("Rasa IT     Connecting..."),console.log(n)})},setUsername=(n,t)=>{consoleLogger("SingnalR: setting username..."),wsconn.invoke("Join",n,t).catch(n=>{consoleLogger(n),alertify.alert("<h4>Failed SignalR Connection<\/h4> We were not able to connect you to the signaling server.<br/><br/>Error: "+JSON.stringify(n)).set({title:"Rasa IT"}).set({delay:5e3})}),$("#upperUsername").text(n),$("div.username").text(n)},generateRandomUsername=()=>{consoleLogger("SignalR: Generating random username...");let n="User "+Math.floor(Math.random()*1e4+1);alertify.success("You really need a username, so we will call you... "+n,5);setUsername(n)},errorHandler=n=>{n.message?alertify.alert("<h4>Error Occurred<\/h4><\/br>Error Info: "+JSON.stringify(n.message)).set({title:"Rasa IT"}).set({delay:5e3}):alertify.alert("<h4>Error Occurred<\/h4><\/br>Error Info: "+JSON.stringify(n)).set({title:"Rasa IT"}).set({delay:5e3}),consoleLogger(n)},consoleLogger=n=>{isDebugging&&console.log(n)};